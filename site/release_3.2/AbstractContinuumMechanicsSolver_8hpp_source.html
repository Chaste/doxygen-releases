<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Chaste: continuum_mechanics/src/solver/AbstractContinuumMechanicsSolver.hpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.2 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_ab035f9c317065b98d758a63823c15cf.html">continuum_mechanics</a>&nbsp;&raquo;&nbsp;<a class="el" href="dir_86696845d9c00e86b57947f8a11c3d43.html">src</a>&nbsp;&raquo;&nbsp;<a class="el" href="dir_37aa8ec7aef44b9473af7d5abcf6d768.html">solver</a>
  </div>
</div>
<div class="contents">
<h1>AbstractContinuumMechanicsSolver.hpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">Copyright (c) 2005-2014, University of Oxford.</span>
<a name="l00004"></a>00004 <span class="comment">All rights reserved.</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">University of Oxford means the Chancellor, Masters and Scholars of the</span>
<a name="l00007"></a>00007 <span class="comment">University of Oxford, having an administrative office at Wellington</span>
<a name="l00008"></a>00008 <span class="comment">Square, Oxford OX1 2JD, UK.</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">This file is part of Chaste.</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
<a name="l00013"></a>00013 <span class="comment">modification, are permitted provided that the following conditions are met:</span>
<a name="l00014"></a>00014 <span class="comment"> * Redistributions of source code must retain the above copyright notice,</span>
<a name="l00015"></a>00015 <span class="comment">   this list of conditions and the following disclaimer.</span>
<a name="l00016"></a>00016 <span class="comment"> * Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00017"></a>00017 <span class="comment">   this list of conditions and the following disclaimer in the documentation</span>
<a name="l00018"></a>00018 <span class="comment">   and/or other materials provided with the distribution.</span>
<a name="l00019"></a>00019 <span class="comment"> * Neither the name of the University of Oxford nor the names of its</span>
<a name="l00020"></a>00020 <span class="comment">   contributors may be used to endorse or promote products derived from this</span>
<a name="l00021"></a>00021 <span class="comment">   software without specific prior written permission.</span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<a name="l00024"></a>00024 <span class="comment">AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00025"></a>00025 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00026"></a>00026 <span class="comment">ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span>
<a name="l00027"></a>00027 <span class="comment">LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00028"></a>00028 <span class="comment">CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE</span>
<a name="l00029"></a>00029 <span class="comment">GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<a name="l00030"></a>00030 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00031"></a>00031 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT</span>
<a name="l00032"></a>00032 <span class="comment">OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00033"></a>00033 <span class="comment"></span>
<a name="l00034"></a>00034 <span class="comment">*/</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#ifndef ABSTRACTCONTINUUMMECHANICSSOLVER_HPP_</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#define ABSTRACTCONTINUUMMECHANICSSOLVER_HPP_</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;ContinuumMechanicsProblemDefinition.hpp&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;CompressibilityType.hpp&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;LinearSystem.hpp&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;OutputFileHandler.hpp&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;ReplicatableVector.hpp&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;AbstractTetrahedralMesh.hpp&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;QuadraticMesh.hpp&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;DistributedQuadraticMesh.hpp&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;Warnings.hpp&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;PetscException.hpp&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;GaussianQuadratureRule.hpp&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="PetscTools_8hpp.html">PetscTools.hpp</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;MechanicsEventHandler.hpp&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;CommandLineArguments.hpp&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;VtkMeshWriter.hpp&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00061"></a>00061 <span class="keyword">typedef</span> <span class="keyword">enum</span> _ApplyDirichletBcsType
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063     LINEAR_PROBLEM,
<a name="l00064"></a>00064     NONLINEAR_PROBLEM_APPLY_TO_RESIDUAL_ONLY,
<a name="l00065"></a>00065     NONLINEAR_PROBLEM_APPLY_TO_EVERYTHING
<a name="l00066"></a>00066 } ApplyDirichletBcsType;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">//forward declarations</span>
<a name="l00069"></a>00069 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt; <span class="keyword">class </span>StressRecoveror;
<a name="l00070"></a>00070 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt; <span class="keyword">class </span><a class="code" href="classVtkNonlinearElasticitySolutionWriter.html">VtkNonlinearElasticitySolutionWriter</a>;
<a name="l00071"></a>00071 
<a name="l00086"></a>00086 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00087"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html">00087</a> <span class="keyword">class </span><a class="code" href="classAbstractContinuumMechanicsSolver.html">AbstractContinuumMechanicsSolver</a>
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089     <span class="keyword">friend</span> <span class="keyword">class </span>StressRecoveror&lt;DIM&gt;;
<a name="l00090"></a>00090     <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classVtkNonlinearElasticitySolutionWriter.html">VtkNonlinearElasticitySolutionWriter</a>&lt;DIM&gt;;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="keyword">protected</span>:
<a name="l00097"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">00097</a>     <a class="code" href="classAbstractTetrahedralMesh.html">AbstractTetrahedralMesh&lt;DIM, DIM&gt;</a>&amp; <a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>;
<a name="l00098"></a>00098 
<a name="l00100"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#aa23997bc213ecd2b1e4addf4918ccb69">00100</a>     <a class="code" href="classContinuumMechanicsProblemDefinition.html">ContinuumMechanicsProblemDefinition&lt;DIM&gt;</a>&amp; <a class="code" href="classAbstractContinuumMechanicsSolver.html#aa23997bc213ecd2b1e4addf4918ccb69">mrProblemDefinition</a>;
<a name="l00101"></a>00101 
<a name="l00103"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#abc23b0f9e5924809053943bae3424855">00103</a>     <span class="keywordtype">bool</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#abc23b0f9e5924809053943bae3424855">mWriteOutput</a>;
<a name="l00104"></a>00104 
<a name="l00106"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#aa441094aecb1dfe7f2d4df0ef078935e">00106</a>     std::string <a class="code" href="classAbstractContinuumMechanicsSolver.html#aa441094aecb1dfe7f2d4df0ef078935e">mOutputDirectory</a>;
<a name="l00107"></a>00107 
<a name="l00109"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a92326470870de16eee07d87b0b2337a3">00109</a>     <a class="code" href="classOutputFileHandler.html">OutputFileHandler</a>* <a class="code" href="classAbstractContinuumMechanicsSolver.html#a92326470870de16eee07d87b0b2337a3">mpOutputFileHandler</a>;
<a name="l00110"></a>00110 
<a name="l00114"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a146debdc814c6699c268d293e18e3edc">00114</a>     std::vector&lt;c_vector&lt;double,DIM&gt; &gt; <a class="code" href="classAbstractContinuumMechanicsSolver.html#a146debdc814c6699c268d293e18e3edc">mSpatialSolution</a>;
<a name="l00115"></a>00115 
<a name="l00117"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a2e0009e406c9eb02b2947fb2bb9f6282">00117</a>     std::vector&lt;double&gt; <a class="code" href="classAbstractContinuumMechanicsSolver.html#a2e0009e406c9eb02b2947fb2bb9f6282">mPressureSolution</a>;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 
<a name="l00126"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">00126</a>     std::vector&lt;double&gt; <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>;
<a name="l00127"></a>00127 
<a name="l00129"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a0750a5e0cc738284803323b59d26ee34">00129</a>     <a class="code" href="classGaussianQuadratureRule.html">GaussianQuadratureRule&lt;DIM&gt;</a>* <a class="code" href="classAbstractContinuumMechanicsSolver.html#a0750a5e0cc738284803323b59d26ee34">mpQuadratureRule</a>;
<a name="l00130"></a>00130 
<a name="l00132"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a46fd372999e615fa9cc9f4eabb7497aa">00132</a>     <a class="code" href="classGaussianQuadratureRule.html">GaussianQuadratureRule</a>&lt;DIM-1&gt;* <a class="code" href="classAbstractContinuumMechanicsSolver.html#a46fd372999e615fa9cc9f4eabb7497aa">mpBoundaryQuadratureRule</a>;
<a name="l00133"></a>00133 
<a name="l00138"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a2afa7e6f8eb5557e0eab1cbf5bab2c6d">00138</a>     CompressibilityType <a class="code" href="classAbstractContinuumMechanicsSolver.html#a2afa7e6f8eb5557e0eab1cbf5bab2c6d">mCompressibilityType</a>;
<a name="l00139"></a>00139 
<a name="l00148"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">00148</a>     <span class="keywordtype">unsigned</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>;
<a name="l00149"></a>00149 
<a name="l00153"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">00153</a>     <span class="keywordtype">unsigned</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>;
<a name="l00154"></a>00154 
<a name="l00160"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a1cea6be4ed0b2fdce673b3224fff9f06">00160</a>     <span class="keywordtype">bool</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a1cea6be4ed0b2fdce673b3224fff9f06">mVerbose</a>;
<a name="l00161"></a>00161 
<a name="l00182"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">00182</a>     <a class="code" href="classVec.html">Vec</a> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>;
<a name="l00183"></a>00183 
<a name="l00187"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a673e7f7845fbb7c2f80496de3b3d3755">00187</a>     <a class="code" href="classVec.html">Vec</a> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a673e7f7845fbb7c2f80496de3b3d3755">mLinearSystemRhsVector</a>;
<a name="l00188"></a>00188 
<a name="l00192"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">00192</a>     <a class="code" href="classMat.html">Mat</a> <a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>;
<a name="l00193"></a>00193 
<a name="l00197"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">00197</a>     <a class="code" href="classVec.html">Vec</a> <a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a>;
<a name="l00198"></a>00198 
<a name="l00202"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">00202</a>     <a class="code" href="classMat.html">Mat</a> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>;
<a name="l00203"></a>00203 
<a name="l00207"></a>00207     <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a51efb6d651249387f4018b3bf1d12503">AllocateMatrixMemory</a>();
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 
<a name="l00235"></a>00235     <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#aff2015aaee9ab29d54812ab7df52cdb0">ApplyDirichletBoundaryConditions</a>(ApplyDirichletBcsType type, <span class="keywordtype">bool</span> symmetricProblem);
<a name="l00236"></a>00236 
<a name="l00269"></a>00269     <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a7ad4ea647ef9cc77a128654cd875bdc8">AddIdentityBlockForDummyPressureVariables</a>(ApplyDirichletBcsType type);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 
<a name="l00288"></a>00288     <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#abbb4dc94a95d6082657868b7af88f473">RemovePressureDummyValuesThroughLinearInterpolation</a>();
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="keyword">public</span>:
<a name="l00298"></a>00298     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a597d440cf022a2718722105d92db290e">AbstractContinuumMechanicsSolver</a>(<a class="code" href="classAbstractTetrahedralMesh.html">AbstractTetrahedralMesh&lt;DIM, DIM&gt;</a>&amp; rQuadMesh,
<a name="l00299"></a>00299                                      <a class="code" href="classContinuumMechanicsProblemDefinition.html">ContinuumMechanicsProblemDefinition&lt;DIM&gt;</a>&amp; rProblemDefinition,
<a name="l00300"></a>00300                                      std::string outputDirectory,
<a name="l00301"></a>00301                                      CompressibilityType compressibilityType);
<a name="l00302"></a>00302 
<a name="l00304"></a>00304     <span class="keyword">virtual</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a4c8eff89ceb7a1e131db6e96ec219096">~AbstractContinuumMechanicsSolver</a>();
<a name="l00305"></a>00305 
<a name="l00317"></a>00317     <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a6d64855299b8c48bc1bea5aabdb242dc">WriteCurrentSpatialSolution</a>(std::string fileName, std::string fileExtension, <span class="keywordtype">int</span> counterToAppend=-1);
<a name="l00318"></a>00318 
<a name="l00331"></a>00331     <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a5bd73daf24062075d89121a79c0e7a67">WriteCurrentPressureSolution</a>( <span class="keywordtype">int</span> counterToAppend=-1);
<a name="l00332"></a>00332 
<a name="l00338"></a>00338     <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#ab1af2777defeef5e80e4cae6ff712530">SetWriteOutput</a>(<span class="keywordtype">bool</span> writeOutput=<span class="keyword">true</span>);
<a name="l00339"></a>00339 
<a name="l00347"></a>00347     <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#acd32a5e1bb931190063959f5a5bb040a">CreateVtkOutput</a>(std::string spatialSolutionName=<span class="stringliteral">&quot;Spatial solution&quot;</span>);
<a name="l00348"></a>00348 
<a name="l00353"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a3912adf9b0055f61d0ae06e9292cb3bf">00353</a>     std::vector&lt;double&gt;&amp; <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3912adf9b0055f61d0ae06e9292cb3bf">rGetCurrentSolution</a>()
<a name="l00354"></a>00354     {
<a name="l00355"></a>00355         <span class="keywordflow">return</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>;
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357 
<a name="l00362"></a>00362     <span class="keyword">virtual</span> std::vector&lt;c_vector&lt;double,DIM&gt; &gt;&amp; <a class="code" href="classAbstractContinuumMechanicsSolver.html#ab3e22eb77e1f658cda9746f591e2eb4d">rGetSpatialSolution</a>()=0;
<a name="l00363"></a>00363 
<a name="l00372"></a>00372     std::vector&lt;double&gt;&amp; <a class="code" href="classAbstractContinuumMechanicsSolver.html#a8bb5efbf95c5e0028020c89c2b19011b">rGetPressures</a>();
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 };
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00378"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a597d440cf022a2718722105d92db290e">00378</a> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a597d440cf022a2718722105d92db290e">AbstractContinuumMechanicsSolver&lt;DIM&gt;::AbstractContinuumMechanicsSolver</a>(<a class="code" href="classAbstractTetrahedralMesh.html">AbstractTetrahedralMesh&lt;DIM, DIM&gt;</a>&amp; rQuadMesh,
<a name="l00379"></a>00379                                                                         <a class="code" href="classContinuumMechanicsProblemDefinition.html">ContinuumMechanicsProblemDefinition&lt;DIM&gt;</a>&amp; rProblemDefinition,
<a name="l00380"></a>00380                                                                         std::string outputDirectory,
<a name="l00381"></a>00381                                                                         CompressibilityType compressibilityType)
<a name="l00382"></a>00382     : mrQuadMesh(rQuadMesh),
<a name="l00383"></a>00383       mrProblemDefinition(rProblemDefinition),
<a name="l00384"></a>00384       mOutputDirectory(outputDirectory),
<a name="l00385"></a>00385       mpOutputFileHandler(NULL),
<a name="l00386"></a>00386       mpQuadratureRule(NULL),
<a name="l00387"></a>00387       mpBoundaryQuadratureRule(NULL),
<a name="l00388"></a>00388       mCompressibilityType(compressibilityType),
<a name="l00389"></a>00389       mResidualVector(NULL),
<a name="l00390"></a>00390       mSystemLhsMatrix(NULL),
<a name="l00391"></a>00391       mPreconditionMatrix(NULL)
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393     assert(DIM==2 || DIM==3);
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="comment">//Check that the mesh is Quadratic</span>
<a name="l00396"></a>00396     <a class="code" href="classQuadraticMesh.html">QuadraticMesh&lt;DIM&gt;</a>* p_quad_mesh = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuadraticMesh.html">QuadraticMesh&lt;DIM&gt;</a>* <span class="keyword">&gt;</span>(&amp;rQuadMesh);
<a name="l00397"></a>00397     <a class="code" href="classDistributedQuadraticMesh.html">DistributedQuadraticMesh&lt;DIM&gt;</a>* p_distributed_quad_mesh = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classDistributedQuadraticMesh.html">DistributedQuadraticMesh&lt;DIM&gt;</a>* <span class="keyword">&gt;</span>(&amp;rQuadMesh);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="keywordflow">if</span>(p_quad_mesh == NULL &amp;&amp; p_distributed_quad_mesh == NULL)
<a name="l00400"></a>00400     {
<a name="l00401"></a>00401         <a class="code" href="Exception_8hpp.html#aa49c727f91093a79c46ee6ecd83548bb">EXCEPTION</a>(<span class="stringliteral">&quot;Continuum mechanics solvers require a quadratic mesh&quot;</span>);
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a1cea6be4ed0b2fdce673b3224fff9f06">mVerbose</a> = (<a class="code" href="classAbstractContinuumMechanicsSolver.html#aa23997bc213ecd2b1e4addf4918ccb69">mrProblemDefinition</a>.GetVerboseDuringSolve() ||
<a name="l00406"></a>00406                 <a class="code" href="classCommandLineArguments.html#a05b160b100db21aec7f47398d12612c0">CommandLineArguments::Instance</a>()-&gt;<a class="code" href="classCommandLineArguments.html#a04fce67b06d8e79ac4e56a1be2f46fa5">OptionExists</a>(<span class="stringliteral">&quot;-mech_verbose&quot;</span>) ||
<a name="l00407"></a>00407                 <a class="code" href="classCommandLineArguments.html#a05b160b100db21aec7f47398d12612c0">CommandLineArguments::Instance</a>()-&gt;<a class="code" href="classCommandLineArguments.html#a04fce67b06d8e79ac4e56a1be2f46fa5">OptionExists</a>(<span class="stringliteral">&quot;-mech_very_verbose&quot;</span>) );
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <a class="code" href="classAbstractContinuumMechanicsSolver.html#abc23b0f9e5924809053943bae3424855">mWriteOutput</a> = (<a class="code" href="classAbstractContinuumMechanicsSolver.html#aa441094aecb1dfe7f2d4df0ef078935e">mOutputDirectory</a> != <span class="stringliteral">&quot;&quot;</span>);
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (<a class="code" href="classAbstractContinuumMechanicsSolver.html#abc23b0f9e5924809053943bae3424855">mWriteOutput</a>)
<a name="l00411"></a>00411     {
<a name="l00412"></a>00412         <a class="code" href="classAbstractContinuumMechanicsSolver.html#a92326470870de16eee07d87b0b2337a3">mpOutputFileHandler</a> = <span class="keyword">new</span> <a class="code" href="classOutputFileHandler.html">OutputFileHandler</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aa441094aecb1dfe7f2d4df0ef078935e">mOutputDirectory</a>);
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="comment">// see dox for mProblemDimension</span>
<a name="l00416"></a>00416     <a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a> = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a2afa7e6f8eb5557e0eab1cbf5bab2c6d">mCompressibilityType</a>==COMPRESSIBLE ? DIM : DIM+1;
<a name="l00417"></a>00417     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a> = <a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*<a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#a2f985d39367ccded5c07cbe2b74c67e4">GetNumNodes</a>();
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a51efb6d651249387f4018b3bf1d12503">AllocateMatrixMemory</a>();
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     <span class="comment">// In general the Jacobian for a mechanics problem is non-polynomial.</span>
<a name="l00422"></a>00422     <span class="comment">// We therefore use the highest order integration rule available.</span>
<a name="l00423"></a>00423     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a0750a5e0cc738284803323b59d26ee34">mpQuadratureRule</a> = <span class="keyword">new</span> <a class="code" href="classGaussianQuadratureRule.html">GaussianQuadratureRule&lt;DIM&gt;</a>(3);
<a name="l00424"></a>00424     <span class="comment">// The boundary forcing terms (or tractions) are also non-polynomial in general.</span>
<a name="l00425"></a>00425     <span class="comment">// Again, we use the highest order integration rule available.</span>
<a name="l00426"></a>00426     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a46fd372999e615fa9cc9f4eabb7497aa">mpBoundaryQuadratureRule</a> = <span class="keyword">new</span> <a class="code" href="classGaussianQuadratureRule.html">GaussianQuadratureRule</a>&lt;DIM-1&gt;(3);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>.resize(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>, 0.0);
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00433"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a4c8eff89ceb7a1e131db6e96ec219096">00433</a> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a4c8eff89ceb7a1e131db6e96ec219096">AbstractContinuumMechanicsSolver&lt;DIM&gt;::~AbstractContinuumMechanicsSolver</a>()
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435     <span class="keywordflow">if</span> (<a class="code" href="classAbstractContinuumMechanicsSolver.html#a92326470870de16eee07d87b0b2337a3">mpOutputFileHandler</a>)
<a name="l00436"></a>00436     {
<a name="l00437"></a>00437         <span class="keyword">delete</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a92326470870de16eee07d87b0b2337a3">mpOutputFileHandler</a>;
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="keywordflow">if</span> (<a class="code" href="classAbstractContinuumMechanicsSolver.html#a0750a5e0cc738284803323b59d26ee34">mpQuadratureRule</a>)
<a name="l00441"></a>00441     {
<a name="l00442"></a>00442         <span class="keyword">delete</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a0750a5e0cc738284803323b59d26ee34">mpQuadratureRule</a>;
<a name="l00443"></a>00443         <span class="keyword">delete</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a46fd372999e615fa9cc9f4eabb7497aa">mpBoundaryQuadratureRule</a>;
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>)
<a name="l00447"></a>00447     {
<a name="l00448"></a>00448         <a class="code" href="classPetscTools.html#a0d218276d49e4605dc5b9272317b4e76">PetscTools::Destroy</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>);
<a name="l00449"></a>00449         <a class="code" href="classPetscTools.html#a0d218276d49e4605dc5b9272317b4e76">PetscTools::Destroy</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a673e7f7845fbb7c2f80496de3b3d3755">mLinearSystemRhsVector</a>);
<a name="l00450"></a>00450         <a class="code" href="classPetscTools.html#a0d218276d49e4605dc5b9272317b4e76">PetscTools::Destroy</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>);
<a name="l00451"></a>00451         <a class="code" href="classPetscTools.html#a0d218276d49e4605dc5b9272317b4e76">PetscTools::Destroy</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>);
<a name="l00452"></a>00452     }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <span class="keywordflow">if</span> (<a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a>)
<a name="l00455"></a>00455     {
<a name="l00456"></a>00456         <a class="code" href="classPetscTools.html#a0d218276d49e4605dc5b9272317b4e76">PetscTools::Destroy</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a>);
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458 }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00461"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a6d64855299b8c48bc1bea5aabdb242dc">00461</a> <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a6d64855299b8c48bc1bea5aabdb242dc">AbstractContinuumMechanicsSolver&lt;DIM&gt;::WriteCurrentSpatialSolution</a>(std::string fileName,
<a name="l00462"></a>00462                                                                         std::string fileExtension,
<a name="l00463"></a>00463                                                                         <span class="keywordtype">int</span> counterToAppend)
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465     <span class="comment">// Only write output if the flag mWriteOutput has been set</span>
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (!<a class="code" href="classAbstractContinuumMechanicsSolver.html#abc23b0f9e5924809053943bae3424855">mWriteOutput</a>)
<a name="l00467"></a>00467     {
<a name="l00468"></a>00468         <span class="keywordflow">return</span>;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="keywordflow">if</span> (<a class="code" href="classPetscTools.html#a30cf1b3576c5dd99556f6b87a05be7cc">PetscTools::AmMaster</a>())
<a name="l00472"></a>00472     {
<a name="l00473"></a>00473         std::stringstream file_name;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         file_name &lt;&lt; fileName;
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (counterToAppend &gt;= 0)
<a name="l00477"></a>00477         {
<a name="l00478"></a>00478             file_name &lt;&lt; <span class="stringliteral">&quot;_&quot;</span> &lt;&lt; counterToAppend;
<a name="l00479"></a>00479         }
<a name="l00480"></a>00480         file_name &lt;&lt; <span class="stringliteral">&quot;.&quot;</span> &lt;&lt; fileExtension;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         out_stream p_file = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a92326470870de16eee07d87b0b2337a3">mpOutputFileHandler</a>-&gt;<a class="code" href="classOutputFileHandler.html#a01752f10d7d7a15355363ee63ce681fe">OpenOutputFile</a>(file_name.str());
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         std::vector&lt;c_vector&lt;double,DIM&gt; &gt;&amp; r_spatial_solution = <a class="code" href="classAbstractContinuumMechanicsSolver.html#ab3e22eb77e1f658cda9746f591e2eb4d">rGetSpatialSolution</a>();
<a name="l00485"></a>00485         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;r_spatial_solution.size(); i++)
<a name="l00486"></a>00486         {
<a name="l00487"></a>00487     <span class="comment">//        for (unsigned j=0; j&lt;DIM; j++)</span>
<a name="l00488"></a>00488     <span class="comment">//        {</span>
<a name="l00489"></a>00489     <span class="comment">//            *p_file &lt;&lt; mrQuadMesh.GetNode(i)-&gt;rGetLocation()[j] &lt;&lt; &quot; &quot;;</span>
<a name="l00490"></a>00490     <span class="comment">//        }</span>
<a name="l00491"></a>00491             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j=0; j&lt;DIM; j++)
<a name="l00492"></a>00492             {
<a name="l00493"></a>00493                 *p_file &lt;&lt; r_spatial_solution[i](j) &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l00494"></a>00494             }
<a name="l00495"></a>00495             *p_file &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497         p_file-&gt;close();
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499     <a class="code" href="classPetscTools.html#a7a807cfd3f93e989e1d90d00650e5c64">PetscTools::Barrier</a>(<span class="stringliteral">&quot;WriteSpatial&quot;</span>);
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00503"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a5bd73daf24062075d89121a79c0e7a67">00503</a> <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a5bd73daf24062075d89121a79c0e7a67">AbstractContinuumMechanicsSolver&lt;DIM&gt;::WriteCurrentPressureSolution</a>(<span class="keywordtype">int</span> counterToAppend)
<a name="l00504"></a>00504 {
<a name="l00505"></a>00505     <span class="comment">// Only write output if the flag mWriteOutput has been set</span>
<a name="l00506"></a>00506     <span class="keywordflow">if</span> (!<a class="code" href="classAbstractContinuumMechanicsSolver.html#abc23b0f9e5924809053943bae3424855">mWriteOutput</a>)
<a name="l00507"></a>00507     {
<a name="l00508"></a>00508         <span class="keywordflow">return</span>;
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     <span class="keywordflow">if</span> (<a class="code" href="classPetscTools.html#a30cf1b3576c5dd99556f6b87a05be7cc">PetscTools::AmMaster</a>())
<a name="l00512"></a>00512     {
<a name="l00513"></a>00513         std::stringstream file_name;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515         file_name &lt;&lt; <span class="stringliteral">&quot;pressure&quot;</span>;
<a name="l00516"></a>00516         <span class="keywordflow">if</span> (counterToAppend &gt;= 0)
<a name="l00517"></a>00517         {
<a name="l00518"></a>00518             file_name &lt;&lt; <span class="stringliteral">&quot;_&quot;</span> &lt;&lt; counterToAppend;
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520         file_name &lt;&lt; <span class="stringliteral">&quot;.txt&quot;</span>;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522         out_stream p_file = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a92326470870de16eee07d87b0b2337a3">mpOutputFileHandler</a>-&gt;<a class="code" href="classOutputFileHandler.html#a01752f10d7d7a15355363ee63ce681fe">OpenOutputFile</a>(file_name.str());
<a name="l00523"></a>00523 
<a name="l00524"></a>00524         std::vector&lt;double&gt;&amp; r_pressure = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a8bb5efbf95c5e0028020c89c2b19011b">rGetPressures</a>();
<a name="l00525"></a>00525         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;r_pressure.size(); i++)
<a name="l00526"></a>00526         {
<a name="l00527"></a>00527             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j=0; j&lt;DIM; j++)
<a name="l00528"></a>00528             {
<a name="l00529"></a>00529                 *p_file &lt;&lt; <a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#a7def27a05d40687d90b5f545b440b8ba">GetNode</a>(i)-&gt;rGetLocation()[j] &lt;&lt; <span class="stringliteral">&quot; &quot;</span>;
<a name="l00530"></a>00530             }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532             *p_file &lt;&lt; r_pressure[i] &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00533"></a>00533         }
<a name="l00534"></a>00534         p_file-&gt;close();
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536     <a class="code" href="classPetscTools.html#a7a807cfd3f93e989e1d90d00650e5c64">PetscTools::Barrier</a>(<span class="stringliteral">&quot;WritePressure&quot;</span>);
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 
<a name="l00540"></a>00540 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00541"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#ab1af2777defeef5e80e4cae6ff712530">00541</a> <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#ab1af2777defeef5e80e4cae6ff712530">AbstractContinuumMechanicsSolver&lt;DIM&gt;::SetWriteOutput</a>(<span class="keywordtype">bool</span> writeOutput)
<a name="l00542"></a>00542 {
<a name="l00543"></a>00543     <span class="keywordflow">if</span> (writeOutput &amp;&amp; (<a class="code" href="classAbstractContinuumMechanicsSolver.html#aa441094aecb1dfe7f2d4df0ef078935e">mOutputDirectory</a>==<span class="stringliteral">&quot;&quot;</span>))
<a name="l00544"></a>00544     {
<a name="l00545"></a>00545         <a class="code" href="Exception_8hpp.html#aa49c727f91093a79c46ee6ecd83548bb">EXCEPTION</a>(<span class="stringliteral">&quot;Can&#39;t write output if no output directory was given in constructor&quot;</span>);
<a name="l00546"></a>00546     }
<a name="l00547"></a>00547     <a class="code" href="classAbstractContinuumMechanicsSolver.html#abc23b0f9e5924809053943bae3424855">mWriteOutput</a> = writeOutput;
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 <span class="comment">// ** TO BE DEPRECATED - see #2321 **</span>
<a name="l00551"></a>00551 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00552"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#acd32a5e1bb931190063959f5a5bb040a">00552</a> <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#acd32a5e1bb931190063959f5a5bb040a">AbstractContinuumMechanicsSolver&lt;DIM&gt;::CreateVtkOutput</a>(std::string spatialSolutionName)
<a name="l00553"></a>00553 {
<a name="l00554"></a>00554     <span class="keywordflow">if</span> (this-&gt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#aa441094aecb1dfe7f2d4df0ef078935e">mOutputDirectory</a>==<span class="stringliteral">&quot;&quot;</span>)
<a name="l00555"></a>00555     {
<a name="l00556"></a>00556         <a class="code" href="Exception_8hpp.html#aa49c727f91093a79c46ee6ecd83548bb">EXCEPTION</a>(<span class="stringliteral">&quot;No output directory was given so no output was written, cannot convert to VTK format&quot;</span>);
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558 <span class="preprocessor">#ifdef CHASTE_VTK</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span>    <a class="code" href="classVtkMeshWriter.html">VtkMeshWriter&lt;DIM, DIM&gt;</a> mesh_writer(this-&gt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#aa441094aecb1dfe7f2d4df0ef078935e">mOutputDirectory</a> + <span class="stringliteral">&quot;/vtk&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, <span class="keyword">true</span>);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     mesh_writer.<a class="code" href="classVtkMeshWriter.html#a00a862e064b85a5596a4135e1029730b">AddPointData</a>(spatialSolutionName, this-&gt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#ab3e22eb77e1f658cda9746f591e2eb4d">rGetSpatialSolution</a>());
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="keywordflow">if</span> (<a class="code" href="classAbstractContinuumMechanicsSolver.html#a2afa7e6f8eb5557e0eab1cbf5bab2c6d">mCompressibilityType</a>==INCOMPRESSIBLE)
<a name="l00564"></a>00564     {
<a name="l00565"></a>00565         mesh_writer.<a class="code" href="classVtkMeshWriter.html#a00a862e064b85a5596a4135e1029730b">AddPointData</a>(<span class="stringliteral">&quot;Pressure&quot;</span>, <a class="code" href="classAbstractContinuumMechanicsSolver.html#a8bb5efbf95c5e0028020c89c2b19011b">rGetPressures</a>());
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="comment">//Output the element attribute as cell data.</span>
<a name="l00569"></a>00569     std::vector&lt;double&gt; element_attribute;
<a name="l00570"></a>00570     <span class="keywordflow">for</span>(<span class="keyword">typename</span> <a class="code" href="classAbstractTetrahedralMesh_1_1ElementIterator.html">QuadraticMesh&lt;DIM&gt;::ElementIterator</a> iter = this-&gt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractTetrahedralMesh.html#a76f353fa97bdc3df3a4be30bb8839bb3">GetElementIteratorBegin</a>();
<a name="l00571"></a>00571         iter != this-&gt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractTetrahedralMesh.html#a882e37dc5497cc485eaeb148dfdf910f">GetElementIteratorEnd</a>();
<a name="l00572"></a>00572         ++iter)
<a name="l00573"></a>00573     {
<a name="l00574"></a>00574         element_attribute.push_back(iter-&gt;GetAttribute());
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576     mesh_writer.<a class="code" href="classVtkMeshWriter.html#a63107170e142a5ea038018f1ac7f7325">AddCellData</a>(<span class="stringliteral">&quot;Attribute&quot;</span>, element_attribute);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     mesh_writer.<a class="code" href="classVtkMeshWriter.html#a916bbe019de8e4956d34b365ca7e11ca">WriteFilesUsingMesh</a>(this-&gt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>);
<a name="l00579"></a>00579 <span class="preprocessor">#endif</span>
<a name="l00580"></a>00580 <span class="preprocessor"></span>}
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00584"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a8bb5efbf95c5e0028020c89c2b19011b">00584</a> std::vector&lt;double&gt;&amp; <a class="code" href="classAbstractContinuumMechanicsSolver.html#a8bb5efbf95c5e0028020c89c2b19011b">AbstractContinuumMechanicsSolver&lt;DIM&gt;::rGetPressures</a>()
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586     assert(<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>==DIM+1);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a2e0009e406c9eb02b2947fb2bb9f6282">mPressureSolution</a>.clear();
<a name="l00589"></a>00589     <a class="code" href="classAbstractContinuumMechanicsSolver.html#a2e0009e406c9eb02b2947fb2bb9f6282">mPressureSolution</a>.resize(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#a2f985d39367ccded5c07cbe2b74c67e4">GetNumNodes</a>());
<a name="l00590"></a>00590 
<a name="l00591"></a>00591     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#a2f985d39367ccded5c07cbe2b74c67e4">GetNumNodes</a>(); i++)
<a name="l00592"></a>00592     {
<a name="l00593"></a>00593         <a class="code" href="classAbstractContinuumMechanicsSolver.html#a2e0009e406c9eb02b2947fb2bb9f6282">mPressureSolution</a>[i] = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*i + DIM];
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595     <span class="keywordflow">return</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a2e0009e406c9eb02b2947fb2bb9f6282">mPressureSolution</a>;
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00600"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#abbb4dc94a95d6082657868b7af88f473">00600</a> <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#abbb4dc94a95d6082657868b7af88f473">AbstractContinuumMechanicsSolver&lt;DIM&gt;::RemovePressureDummyValuesThroughLinearInterpolation</a>()
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602     assert(<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>==DIM+1);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="comment">// For quadratic triangles, node 3 is between nodes 1 and 2, node 4 is between 0 and 2, etc</span>
<a name="l00605"></a>00605     <span class="keywordtype">unsigned</span> internal_nodes_2d[3] = {3,4,5};
<a name="l00606"></a>00606     <span class="keywordtype">unsigned</span> neighbouring_vertices_2d[3][2] = { {1,2}, {2,0}, {0,1} };
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     <span class="comment">// ordering for quadratic tetrahedra</span>
<a name="l00609"></a>00609     <span class="keywordtype">unsigned</span> internal_nodes_3d[6] = {4,5,6,7,8,9};
<a name="l00610"></a>00610     <span class="keywordtype">unsigned</span> neighbouring_vertices_3d[6][2] = { {0,1}, {1,2}, {0,2}, {0,3}, {1,3}, {2,3} };
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="keywordtype">unsigned</span> num_internal_nodes_per_element = DIM==2 ? 3 : 6;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="comment">// loop over elements, then loop over edges.</span>
<a name="l00615"></a>00615     <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classAbstractTetrahedralMesh.html">AbstractTetrahedralMesh&lt;DIM,DIM&gt;::ElementIterator</a> iter = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractTetrahedralMesh.html#a76f353fa97bdc3df3a4be30bb8839bb3">GetElementIteratorBegin</a>();
<a name="l00616"></a>00616          iter != <a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractTetrahedralMesh.html#a882e37dc5497cc485eaeb148dfdf910f">GetElementIteratorEnd</a>();
<a name="l00617"></a>00617          ++iter)
<a name="l00618"></a>00618     {
<a name="l00619"></a>00619         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0; i&lt;num_internal_nodes_per_element; i++)
<a name="l00620"></a>00620         {
<a name="l00621"></a>00621             <span class="keywordtype">unsigned</span> global_index;
<a name="l00622"></a>00622             <span class="keywordtype">double</span> left_val;
<a name="l00623"></a>00623             <span class="keywordtype">double</span> right_val;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625             <span class="keywordflow">if</span>(DIM==2)
<a name="l00626"></a>00626             {
<a name="l00627"></a>00627                 global_index = iter-&gt;GetNodeGlobalIndex( internal_nodes_2d[i] );
<a name="l00628"></a>00628                 <span class="keywordtype">unsigned</span> vertex_0_global_index =iter-&gt;GetNodeGlobalIndex( neighbouring_vertices_2d[i][0] );
<a name="l00629"></a>00629                 <span class="keywordtype">unsigned</span> vertex_1_global_index =iter-&gt;GetNodeGlobalIndex( neighbouring_vertices_2d[i][1] );
<a name="l00630"></a>00630                 left_val = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*vertex_0_global_index + DIM];
<a name="l00631"></a>00631                 right_val = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*vertex_1_global_index + DIM];
<a name="l00632"></a>00632             }
<a name="l00633"></a>00633             <span class="keywordflow">else</span>
<a name="l00634"></a>00634             {
<a name="l00635"></a>00635                 global_index = iter-&gt;GetNodeGlobalIndex( internal_nodes_3d[i] );
<a name="l00636"></a>00636                 <span class="keywordtype">unsigned</span> vertex_0_global_index =iter-&gt;GetNodeGlobalIndex( neighbouring_vertices_3d[i][0] );
<a name="l00637"></a>00637                 <span class="keywordtype">unsigned</span> vertex_1_global_index =iter-&gt;GetNodeGlobalIndex( neighbouring_vertices_3d[i][1] );
<a name="l00638"></a>00638                 left_val = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*vertex_0_global_index + DIM];
<a name="l00639"></a>00639                 right_val = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*vertex_1_global_index + DIM];
<a name="l00640"></a>00640             }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642             <span class="comment">// this line assumes the internal node is midway between the two vertices</span>
<a name="l00643"></a>00643             <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*global_index + DIM] =  0.5 * (left_val + right_val);
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="comment">/*</span>
<a name="l00649"></a>00649 <span class="comment"> * This method applies the appropriate BCs to the residual and/or linear system</span>
<a name="l00650"></a>00650 <span class="comment"> *</span>
<a name="l00651"></a>00651 <span class="comment"> * For the latter, and second input parameter==true, the BCs are imposed in such a way as</span>
<a name="l00652"></a>00652 <span class="comment"> * to ensure that a symmetric linear system remains symmetric. For each row with boundary condition</span>
<a name="l00653"></a>00653 <span class="comment"> * applied, both the row and column are zero&#39;d and the RHS vector modified to take into account the</span>
<a name="l00654"></a>00654 <span class="comment"> * zero&#39;d column.</span>
<a name="l00655"></a>00655 <span class="comment"> *</span>
<a name="l00656"></a>00656 <span class="comment"> * Suppose we have a matrix</span>
<a name="l00657"></a>00657 <span class="comment"> * [a b c] [x] = [ b1 ]</span>
<a name="l00658"></a>00658 <span class="comment"> * [d e f] [y]   [ b2 ]</span>
<a name="l00659"></a>00659 <span class="comment"> * [g h i] [z]   [ b3 ]</span>
<a name="l00660"></a>00660 <span class="comment"> * and we want to apply the boundary condition x=v without losing symmetry if the matrix is</span>
<a name="l00661"></a>00661 <span class="comment"> * symmetric. We apply the boundary condition</span>
<a name="l00662"></a>00662 <span class="comment"> * [1 0 0] [x] = [ v  ]</span>
<a name="l00663"></a>00663 <span class="comment"> * [d e f] [y]   [ b2 ]</span>
<a name="l00664"></a>00664 <span class="comment"> * [g h i] [z]   [ b3 ]</span>
<a name="l00665"></a>00665 <span class="comment"> * and then zero the column as well, adding a term to the RHS to take account for the</span>
<a name="l00666"></a>00666 <span class="comment"> * zero-matrix components</span>
<a name="l00667"></a>00667 <span class="comment"> * [1 0 0] [x] = [ v  ] - v[ 0 ]</span>
<a name="l00668"></a>00668 <span class="comment"> * [0 e f] [y]   [ b2 ]    [ d ]</span>
<a name="l00669"></a>00669 <span class="comment"> * [0 h i] [z]   [ b3 ]    [ g ]</span>
<a name="l00670"></a>00670 <span class="comment"> * Note the last term is the first column of the matrix, with one component zeroed, and</span>
<a name="l00671"></a>00671 <span class="comment"> * multiplied by the boundary condition value. This last term is then stored in</span>
<a name="l00672"></a>00672 <span class="comment"> * mDirichletBoundaryConditionsVector, and in general is equal to:</span>
<a name="l00673"></a>00673 <span class="comment"> * SUM_{d=1..D} v_d a&#39;_d</span>
<a name="l00674"></a>00674 <span class="comment"> * where v_d is the boundary value of boundary condition d (d an index into the matrix),</span>
<a name="l00675"></a>00675 <span class="comment"> * and a&#39;_d is the dth-column of the matrix but with the d-th component zeroed, and where</span>
<a name="l00676"></a>00676 <span class="comment"> * there are D boundary conditions</span>
<a name="l00677"></a>00677 <span class="comment"> */</span>
<a name="l00678"></a>00678 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00679"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#aff2015aaee9ab29d54812ab7df52cdb0">00679</a> <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#aff2015aaee9ab29d54812ab7df52cdb0">AbstractContinuumMechanicsSolver&lt;DIM&gt;::ApplyDirichletBoundaryConditions</a>(ApplyDirichletBcsType type, <span class="keywordtype">bool</span> symmetricProblem)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681     std::vector&lt;unsigned&gt; rows;
<a name="l00682"></a>00682     std::vector&lt;double&gt; values;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <span class="comment">// Whether to apply symmetrically, ie alter columns as well as rows (see comment above)</span>
<a name="l00685"></a>00685     <span class="keywordtype">bool</span> applySymmetrically = (type!=NONLINEAR_PROBLEM_APPLY_TO_RESIDUAL_ONLY) &amp;&amp; symmetricProblem;
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     <span class="keywordflow">if</span> (applySymmetrically)
<a name="l00688"></a>00688     {
<a name="l00689"></a>00689         <span class="keywordflow">if</span>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a>==NULL)
<a name="l00690"></a>00690         {
<a name="l00691"></a>00691             VecDuplicate(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>, &amp;<a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a>);
<a name="l00692"></a>00692         }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         <a class="code" href="classPetscVecTools.html#afe1575d0c95b1527b2dcc98e17d01e4d">PetscVecTools::Zero</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a>);
<a name="l00695"></a>00695         <a class="code" href="classPetscMatTools.html#aa9717ce944536cda4afaac557aba7254">PetscMatTools::Finalise</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>);
<a name="l00696"></a>00696     }
<a name="l00697"></a>00697 
<a name="l00699"></a>00699     <span class="comment">// collect the entries to be altered</span>
<a name="l00701"></a>00701 <span class="comment"></span>
<a name="l00702"></a>00702     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#aa23997bc213ecd2b1e4addf4918ccb69">mrProblemDefinition</a>.rGetDirichletNodes().size(); i++)
<a name="l00703"></a>00703     {
<a name="l00704"></a>00704         <span class="keywordtype">unsigned</span> node_index = <a class="code" href="classAbstractContinuumMechanicsSolver.html#aa23997bc213ecd2b1e4addf4918ccb69">mrProblemDefinition</a>.rGetDirichletNodes()[i];
<a name="l00705"></a>00705 
<a name="l00706"></a>00706         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j=0; j&lt;DIM; j++)
<a name="l00707"></a>00707         {
<a name="l00708"></a>00708             <span class="keywordtype">double</span> dirichlet_val = <a class="code" href="classAbstractContinuumMechanicsSolver.html#aa23997bc213ecd2b1e4addf4918ccb69">mrProblemDefinition</a>.rGetDirichletNodeValues()[i](j);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710             <span class="keywordflow">if</span>(dirichlet_val != <a class="code" href="classContinuumMechanicsProblemDefinition.html">ContinuumMechanicsProblemDefinition&lt;DIM&gt;::FREE</a>)
<a name="l00711"></a>00711             {
<a name="l00712"></a>00712                 <span class="keywordtype">double</span> val;
<a name="l00713"></a>00713                 <span class="keywordtype">unsigned</span> dof_index = <a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*node_index+j;
<a name="l00714"></a>00714 
<a name="l00715"></a>00715                 <span class="keywordflow">if</span>(type == LINEAR_PROBLEM)
<a name="l00716"></a>00716                 {
<a name="l00717"></a>00717                     val = dirichlet_val;
<a name="l00718"></a>00718                 }
<a name="l00719"></a>00719                 <span class="keywordflow">else</span>
<a name="l00720"></a>00720                 {
<a name="l00721"></a>00721                     <span class="comment">// The boundary conditions on the NONLINEAR SYSTEM are x=boundary_values</span>
<a name="l00722"></a>00722                     <span class="comment">// on the boundary nodes. However:</span>
<a name="l00723"></a>00723                     <span class="comment">// The boundary conditions on the LINEAR SYSTEM at each Newton step (Ju=f,</span>
<a name="l00724"></a>00724                     <span class="comment">// where J is the Jacobian, u the negative update vector and f is the residual) is:</span>
<a name="l00725"></a>00725                     <span class="comment">// u=current_soln-boundary_values on the boundary nodes</span>
<a name="l00726"></a>00726                     val = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[dof_index] - dirichlet_val;
<a name="l00727"></a>00727                 }
<a name="l00728"></a>00728                 rows.push_back(dof_index);
<a name="l00729"></a>00729                 values.push_back(val);
<a name="l00730"></a>00730             }
<a name="l00731"></a>00731         }
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733 
<a name="l00735"></a>00735     <span class="comment">// do the alterations</span>
<a name="l00737"></a>00737 <span class="comment"></span>
<a name="l00738"></a>00738     <span class="keywordflow">if</span> (applySymmetrically)
<a name="l00739"></a>00739     {
<a name="l00740"></a>00740         <span class="comment">// Modify the matrix columns</span>
<a name="l00741"></a>00741         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;rows.size(); i++)
<a name="l00742"></a>00742         {
<a name="l00743"></a>00743             <span class="keywordtype">unsigned</span> col = rows[i];
<a name="l00744"></a>00744             <span class="keywordtype">double</span> minus_value = -values[i];
<a name="l00745"></a>00745 
<a name="l00746"></a>00746             <span class="comment">// Get a vector which will store the column of the matrix (column d, where d is</span>
<a name="l00747"></a>00747             <span class="comment">// the index of the row (and column) to be altered for the boundary condition.</span>
<a name="l00748"></a>00748             <span class="comment">// Since the matrix is symmetric when get row number &quot;col&quot; and treat it as a column.</span>
<a name="l00749"></a>00749             <span class="comment">// PETSc uses compressed row format and therefore getting rows is far more efficient</span>
<a name="l00750"></a>00750             <span class="comment">// than getting columns.</span>
<a name="l00751"></a>00751             <a class="code" href="classVec.html">Vec</a> matrix_col = <a class="code" href="classPetscMatTools.html#a8a201396f082f8e0cb5b27cc4694f8d8">PetscMatTools::GetMatrixRowDistributed</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>,col);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753             <span class="comment">// Zero the correct entry of the column</span>
<a name="l00754"></a>00754             <a class="code" href="classPetscVecTools.html#afaeb1be761c448205b29efbcf77336fe">PetscVecTools::SetElement</a>(matrix_col, col, 0.0);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756             <span class="comment">// Set up the RHS Dirichlet boundary conditions vector</span>
<a name="l00757"></a>00757             <span class="comment">// E.g. for a boundary node at the zeroth node (x_0 = value), this is equal to</span>
<a name="l00758"></a>00758             <span class="comment">//   -value*[0 a_21 a_31 .. a_N1]</span>
<a name="l00759"></a>00759             <span class="comment">// and will be added to the RHS.</span>
<a name="l00760"></a>00760             <a class="code" href="classPetscVecTools.html#a96877007e2946f9530e9d6281385d751">PetscVecTools::AddScaledVector</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a>, matrix_col, minus_value);
<a name="l00761"></a>00761             <a class="code" href="classPetscTools.html#a0d218276d49e4605dc5b9272317b4e76">PetscTools::Destroy</a>(matrix_col);
<a name="l00762"></a>00762         }
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     <span class="keywordflow">if</span> (type!=NONLINEAR_PROBLEM_APPLY_TO_RESIDUAL_ONLY) <span class="comment">// ie doing a whole linear system</span>
<a name="l00766"></a>00766     {
<a name="l00767"></a>00767         <span class="comment">// Now zero the appropriate rows and columns of the matrix. If the matrix is symmetric we apply the</span>
<a name="l00768"></a>00768         <span class="comment">// boundary conditions in a way the symmetry isn&#39;t lost (rows and columns). If not only the row is</span>
<a name="l00769"></a>00769         <span class="comment">// zeroed.</span>
<a name="l00770"></a>00770         <span class="keywordflow">if</span> (applySymmetrically)
<a name="l00771"></a>00771         {
<a name="l00772"></a>00772             <a class="code" href="classPetscMatTools.html#a742a2bec669f75b1067b282ce6cf3b11">PetscMatTools::ZeroRowsAndColumnsWithValueOnDiagonal</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>, rows, 1.0);
<a name="l00773"></a>00773             <a class="code" href="classPetscMatTools.html#a742a2bec669f75b1067b282ce6cf3b11">PetscMatTools::ZeroRowsAndColumnsWithValueOnDiagonal</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, rows, 1.0);
<a name="l00774"></a>00774 
<a name="l00775"></a>00775             <span class="comment">// Apply the RHS boundary conditions modification if required.</span>
<a name="l00776"></a>00776             <a class="code" href="classPetscVecTools.html#a96877007e2946f9530e9d6281385d751">PetscVecTools::AddScaledVector</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a673e7f7845fbb7c2f80496de3b3d3755">mLinearSystemRhsVector</a>, <a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a>, 1.0);
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778         <span class="keywordflow">else</span>
<a name="l00779"></a>00779         {
<a name="l00780"></a>00780             <a class="code" href="classPetscMatTools.html#a5a68cf8b1e9a1630f54a60feb03084b9">PetscMatTools::ZeroRowsWithValueOnDiagonal</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>, rows, 1.0);
<a name="l00781"></a>00781             <a class="code" href="classPetscMatTools.html#a5a68cf8b1e9a1630f54a60feb03084b9">PetscMatTools::ZeroRowsWithValueOnDiagonal</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, rows, 1.0);
<a name="l00782"></a>00782         }
<a name="l00783"></a>00783     }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785     <span class="keywordflow">if</span> (type!=LINEAR_PROBLEM)
<a name="l00786"></a>00786     {
<a name="l00787"></a>00787         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;rows.size(); i++)
<a name="l00788"></a>00788         {
<a name="l00789"></a>00789             <a class="code" href="classPetscVecTools.html#afaeb1be761c448205b29efbcf77336fe">PetscVecTools::SetElement</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>, rows[i], values[i]);
<a name="l00790"></a>00790         }
<a name="l00791"></a>00791     }
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (type!=NONLINEAR_PROBLEM_APPLY_TO_RESIDUAL_ONLY)
<a name="l00794"></a>00794     {
<a name="l00795"></a>00795         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;rows.size(); i++)
<a name="l00796"></a>00796         {
<a name="l00797"></a>00797             <a class="code" href="classPetscVecTools.html#afaeb1be761c448205b29efbcf77336fe">PetscVecTools::SetElement</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a673e7f7845fbb7c2f80496de3b3d3755">mLinearSystemRhsVector</a>, rows[i], values[i]);
<a name="l00798"></a>00798         }
<a name="l00799"></a>00799     }
<a name="l00800"></a>00800 }
<a name="l00801"></a>00801 
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00804"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a7ad4ea647ef9cc77a128654cd875bdc8">00804</a> <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a7ad4ea647ef9cc77a128654cd875bdc8">AbstractContinuumMechanicsSolver&lt;DIM&gt;::AddIdentityBlockForDummyPressureVariables</a>(ApplyDirichletBcsType type)
<a name="l00805"></a>00805 {
<a name="l00806"></a>00806     assert(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a2afa7e6f8eb5557e0eab1cbf5bab2c6d">mCompressibilityType</a>==INCOMPRESSIBLE);
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     <span class="keywordtype">int</span> lo, hi;
<a name="l00809"></a>00809     VecGetOwnershipRange(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>, &amp;lo, &amp;hi);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0; i&lt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#a2f985d39367ccded5c07cbe2b74c67e4">GetNumNodes</a>(); i++)
<a name="l00812"></a>00812     {
<a name="l00813"></a>00813         <span class="keywordflow">if</span>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#a7def27a05d40687d90b5f545b440b8ba">GetNode</a>(i)-&gt;IsInternal())
<a name="l00814"></a>00814         {
<a name="l00815"></a>00815             <span class="keywordtype">unsigned</span> row = (DIM+1)*i + DIM; <span class="comment">// DIM+1 is the problem dimension</span>
<a name="l00816"></a>00816             <span class="keywordflow">if</span>(lo &lt;= (<span class="keywordtype">int</span>)row &amp;&amp; (int)row &lt; hi)
<a name="l00817"></a>00817             {
<a name="l00818"></a>00818                 <span class="keywordflow">if</span>(type!=LINEAR_PROBLEM)
<a name="l00819"></a>00819                 {
<a name="l00820"></a>00820                     <a class="code" href="classPetscVecTools.html#afaeb1be761c448205b29efbcf77336fe">PetscVecTools::SetElement</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>, row, <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[row]-0.0);
<a name="l00821"></a>00821                 }
<a name="l00822"></a>00822                 <span class="keywordflow">if</span>(type!=NONLINEAR_PROBLEM_APPLY_TO_RESIDUAL_ONLY) <span class="comment">// ie doing a whole linear system</span>
<a name="l00823"></a>00823                 {
<a name="l00824"></a>00824                     <span class="keywordtype">double</span> rhs_vector_val = type==LINEAR_PROBLEM ? 0.0 : <a class="code" href="classAbstractContinuumMechanicsSolver.html#a59782d56383f1d50a4cb4b1e5ce2adaa">mCurrentSolution</a>[row]-0.0;
<a name="l00825"></a>00825                     <a class="code" href="classPetscVecTools.html#afaeb1be761c448205b29efbcf77336fe">PetscVecTools::SetElement</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a673e7f7845fbb7c2f80496de3b3d3755">mLinearSystemRhsVector</a>, row, rhs_vector_val);
<a name="l00826"></a>00826                     <span class="comment">// this assumes the row is already zero, which is should be..</span>
<a name="l00827"></a>00827                     <a class="code" href="classPetscMatTools.html#ad2991678b6341cb488fcf53bca9c7af1">PetscMatTools::SetElement</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>, row, row, 1.0);
<a name="l00828"></a>00828                     <a class="code" href="classPetscMatTools.html#ad2991678b6341cb488fcf53bca9c7af1">PetscMatTools::SetElement</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, row, row, 1.0);
<a name="l00829"></a>00829                 }
<a name="l00830"></a>00830             }
<a name="l00831"></a>00831         }
<a name="l00832"></a>00832     }
<a name="l00833"></a>00833 }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 <span class="keyword">template</span>&lt;<span class="keywordtype">unsigned</span> DIM&gt;
<a name="l00838"></a><a class="code" href="classAbstractContinuumMechanicsSolver.html#a51efb6d651249387f4018b3bf1d12503">00838</a> <span class="keywordtype">void</span> <a class="code" href="classAbstractContinuumMechanicsSolver.html#a51efb6d651249387f4018b3bf1d12503">AbstractContinuumMechanicsSolver&lt;DIM&gt;::AllocateMatrixMemory</a>()
<a name="l00839"></a>00839 {
<a name="l00840"></a>00840     <a class="code" href="classVec.html">Vec</a> template_vec = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#a0709b81de1a08d65fb21bd61e3512c98">GetDistributedVectorFactory</a>()-&gt;<a class="code" href="classDistributedVectorFactory.html#a9f6e8e2b9056afd1a09c82f1fa5f33b8">CreateVec</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>);
<a name="l00841"></a>00841 
<a name="l00843"></a>00843     <span class="comment">// three vectors</span>
<a name="l00845"></a>00845 <span class="comment"></span>    VecDuplicate(template_vec, &amp;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>);
<a name="l00846"></a>00846     VecDuplicate(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>, &amp;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a673e7f7845fbb7c2f80496de3b3d3755">mLinearSystemRhsVector</a>);
<a name="l00847"></a>00847     <span class="comment">// the one is only allocated if it will be needed (in ApplyDirichletBoundaryConditions),</span>
<a name="l00848"></a>00848     <span class="comment">// depending on whether the matrix is kept symmetric.</span>
<a name="l00849"></a>00849     <a class="code" href="classAbstractContinuumMechanicsSolver.html#adb91b467a7b9509bc710ca71ae17d578">mDirichletBoundaryConditionsVector</a> = NULL;
<a name="l00850"></a>00850     <a class="code" href="classPetscTools.html#a0d218276d49e4605dc5b9272317b4e76">PetscTools::Destroy</a>(template_vec);
<a name="l00851"></a>00851 
<a name="l00853"></a>00853     <span class="comment">// two matrices</span>
<a name="l00855"></a>00855 <span class="comment"></span>
<a name="l00856"></a>00856     <span class="keywordtype">int</span> lo, hi;
<a name="l00857"></a>00857     VecGetOwnershipRange(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3053c8021a46b921b19452b9cda23a89">mResidualVector</a>, &amp;lo, &amp;hi);
<a name="l00858"></a>00858     <a class="code" href="classPetscInt.html">PetscInt</a> local_size = hi - lo;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <span class="keywordflow">if</span> (DIM==2)
<a name="l00862"></a>00862     {
<a name="l00863"></a>00863         <span class="comment">// 2D: N elements around a point =&gt; 7N+3 non-zeros in that row? Assume N&lt;=10 (structured mesh would have N_max=6) =&gt; 73.</span>
<a name="l00864"></a>00864         <span class="keywordtype">unsigned</span> num_non_zeros = std::min(75u, <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866         <a class="code" href="classPetscTools.html#ad6d7a60499c5a6bd9c64eb35fffd3b06">PetscTools::SetupMat</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>, <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>, <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>, num_non_zeros, local_size, local_size);
<a name="l00867"></a>00867         <a class="code" href="classPetscTools.html#ad6d7a60499c5a6bd9c64eb35fffd3b06">PetscTools::SetupMat</a>(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>, <a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>, num_non_zeros, local_size, local_size);
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869     <span class="keywordflow">else</span>
<a name="l00870"></a>00870     {
<a name="l00871"></a>00871         assert(DIM==3);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873         <span class="comment">// in 3d we get the number of containing elements for each node and use that to obtain an upper bound</span>
<a name="l00874"></a>00874         <span class="comment">// for the number of non-zeros for each DOF associated with that node.</span>
<a name="l00875"></a>00875 
<a name="l00876"></a>00876         <span class="keywordtype">int</span>* num_non_zeros_each_row = <span class="keyword">new</span> <span class="keywordtype">int</span>[<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>];
<a name="l00877"></a>00877         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a3697ca8ca5b9136dafc039422aff1ad3">mNumDofs</a>; i++)
<a name="l00878"></a>00878         {
<a name="l00879"></a>00879             num_non_zeros_each_row[i] = 0;
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882         <span class="keywordflow">for</span> (<span class="keyword">typename</span> <a class="code" href="classAbstractMesh.html">AbstractMesh&lt;DIM,DIM&gt;::NodeIterator</a> iter = <a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#ae5eeec312080b395625ed8bc6787edcd">GetNodeIteratorBegin</a>();
<a name="l00883"></a>00883              iter != <a class="code" href="classAbstractContinuumMechanicsSolver.html#a23ea38495527f46d6fc0c4568ac325a7">mrQuadMesh</a>.<a class="code" href="classAbstractMesh.html#a52a3f76f6ad6739062165f01485761da">GetNodeIteratorEnd</a>();
<a name="l00884"></a>00884              ++iter)
<a name="l00885"></a>00885         {
<a name="l00886"></a>00886             <span class="comment">// this upper bound neglects the fact that two containing elements will share the same nodes..</span>
<a name="l00887"></a>00887             <span class="comment">// 4 = max num dofs associated with this node</span>
<a name="l00888"></a>00888             <span class="comment">// 30 = 3*9+3 = 3 dimensions x 9 other nodes on this element   +  3 vertices with a pressure unknown</span>
<a name="l00889"></a>00889             <span class="keywordtype">unsigned</span> num_non_zeros_upper_bound = 4 + 30*iter-&gt;GetNumContainingElements();
<a name="l00890"></a>00890 
<a name="l00891"></a>00891             num_non_zeros_upper_bound = std::min(num_non_zeros_upper_bound, mNumDofs);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893             <span class="keywordtype">unsigned</span> i = iter-&gt;GetIndex();
<a name="l00894"></a>00894 
<a name="l00895"></a>00895             num_non_zeros_each_row[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*i + 0] = num_non_zeros_upper_bound;
<a name="l00896"></a>00896             num_non_zeros_each_row[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*i + 1] = num_non_zeros_upper_bound;
<a name="l00897"></a>00897             num_non_zeros_each_row[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*i + 2] = num_non_zeros_upper_bound;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899             <span class="keywordflow">if</span> (<a class="code" href="classAbstractContinuumMechanicsSolver.html#a2afa7e6f8eb5557e0eab1cbf5bab2c6d">mCompressibilityType</a>==INCOMPRESSIBLE)
<a name="l00900"></a>00900             {
<a name="l00901"></a>00901                 <span class="keywordflow">if</span>(!iter-&gt;IsInternal())
<a name="l00902"></a>00902                 {
<a name="l00903"></a>00903                     num_non_zeros_each_row[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*i + 3] = num_non_zeros_upper_bound;
<a name="l00904"></a>00904                 }
<a name="l00905"></a>00905                 <span class="keywordflow">else</span>
<a name="l00906"></a>00906                 {
<a name="l00907"></a>00907                     num_non_zeros_each_row[<a class="code" href="classAbstractContinuumMechanicsSolver.html#af48614c6c4115f6166d262661268b373">mProblemDimension</a>*i + 3] = 1;
<a name="l00908"></a>00908                 }
<a name="l00909"></a>00909             }
<a name="l00910"></a>00910         }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912         <span class="comment">// NOTE: PetscTools::SetupMat() or the below creates a MATAIJ matrix, which means the matrix will</span>
<a name="l00913"></a>00913         <span class="comment">// be of type MATSEQAIJ if num_procs=1 and MATMPIAIJ otherwise. In the former case</span>
<a name="l00914"></a>00914         <span class="comment">// MatSeqAIJSetPreallocation MUST be called [MatMPIAIJSetPreallocation will have</span>
<a name="l00915"></a>00915         <span class="comment">// no effect (silently)], and vice versa in the latter case</span>
<a name="l00916"></a>00916 
<a name="l00919"></a>00919         <span class="comment">//PetscTools::SetupMat(mSystemLhsMatrix, mNumDofs, mNumDofs, 0, PETSC_DECIDE, PETSC_DECIDE);</span>
<a name="l00920"></a>00920         <span class="comment">//PetscTools::SetupMat(mPreconditionMatrix, mNumDofs, mNumDofs, 0, PETSC_DECIDE, PETSC_DECIDE);</span>
<a name="l00922"></a>00922 <span class="comment"></span>
<a name="l00923"></a>00923         <span class="comment">// possible todo: create a PetscTools::SetupMatNoAllocation()</span>
<a name="l00924"></a>00924 
<a name="l00925"></a>00925 
<a name="l00926"></a>00926 <span class="preprocessor">#if (PETSC_VERSION_MAJOR == 2 &amp;&amp; PETSC_VERSION_MINOR == 2) //PETSc 2.2</span>
<a name="l00927"></a>00927 <span class="preprocessor"></span>        MatCreate(PETSC_COMM_WORLD,local_size,local_size,mNumDofs,mNumDofs,&amp;<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>);
<a name="l00928"></a>00928         MatCreate(PETSC_COMM_WORLD,local_size,local_size,mNumDofs,mNumDofs,&amp;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>);
<a name="l00929"></a>00929 <span class="preprocessor">#else //New API</span>
<a name="l00930"></a>00930 <span class="preprocessor"></span>        MatCreate(PETSC_COMM_WORLD,&amp;<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>);
<a name="l00931"></a>00931         MatCreate(PETSC_COMM_WORLD,&amp;<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>);
<a name="l00932"></a>00932         MatSetSizes(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>,local_size,local_size,mNumDofs,mNumDofs);
<a name="l00933"></a>00933         MatSetSizes(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>,local_size,local_size,mNumDofs,mNumDofs);
<a name="l00934"></a>00934 <span class="preprocessor">#endif</span>
<a name="l00935"></a>00935 <span class="preprocessor"></span>
<a name="l00936"></a>00936         <span class="keywordflow">if</span> (<a class="code" href="classPetscTools.html#a850294f254244f4f006695ba4052ab33">PetscTools::IsSequential</a>())
<a name="l00937"></a>00937         {
<a name="l00938"></a>00938             MatSetType(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>, MATSEQAIJ);
<a name="l00939"></a>00939             MatSetType(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, MATSEQAIJ);
<a name="l00940"></a>00940             MatSeqAIJSetPreallocation(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>,    PETSC_DEFAULT, num_non_zeros_each_row);
<a name="l00941"></a>00941             MatSeqAIJSetPreallocation(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, PETSC_DEFAULT, num_non_zeros_each_row);
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943         <span class="keywordflow">else</span>
<a name="l00944"></a>00944         {
<a name="l00945"></a>00945             <span class="keywordtype">int</span>* num_non_zeros_each_row_in_diag = <span class="keyword">new</span> <span class="keywordtype">int</span>[local_size];
<a name="l00946"></a>00946             <span class="keywordtype">int</span>* num_non_zeros_each_row_off_diag = <span class="keyword">new</span> <span class="keywordtype">int</span>[local_size];
<a name="l00947"></a>00947             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;<a class="code" href="classunsigned.html">unsigned</a>(local_size); i++)
<a name="l00948"></a>00948             {
<a name="l00949"></a>00949                 num_non_zeros_each_row_in_diag[i] = num_non_zeros_each_row[lo+i];
<a name="l00950"></a>00950                 num_non_zeros_each_row_off_diag[i] = num_non_zeros_each_row[lo+i];
<a name="l00951"></a>00951                 <span class="comment">// In the on process (&quot;diagonal block&quot;) there cannot be more non-zero columns specified than there are rows</span>
<a name="l00952"></a>00952                 <span class="keywordflow">if</span>(num_non_zeros_each_row_in_diag[i] &gt; local_size)
<a name="l00953"></a>00953                 {
<a name="l00954"></a>00954                     num_non_zeros_each_row_in_diag[i] = local_size;
<a name="l00955"></a>00955                 }
<a name="l00956"></a>00956             }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958             MatSetType(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>, MATMPIAIJ);
<a name="l00959"></a>00959             MatSetType(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, MATMPIAIJ);
<a name="l00960"></a>00960             MatMPIAIJSetPreallocation(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>,    PETSC_DEFAULT, num_non_zeros_each_row_in_diag, PETSC_DEFAULT, num_non_zeros_each_row_off_diag);
<a name="l00961"></a>00961             MatMPIAIJSetPreallocation(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, PETSC_DEFAULT, num_non_zeros_each_row_in_diag, PETSC_DEFAULT, num_non_zeros_each_row_off_diag);
<a name="l00962"></a>00962         }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964         MatSetFromOptions(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>);
<a name="l00965"></a>00965         MatSetFromOptions(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>);
<a name="l00966"></a>00966 <span class="preprocessor">#if (PETSC_VERSION_MAJOR == 3) //PETSc 3.x.x</span>
<a name="l00967"></a>00967 <span class="preprocessor"></span>        MatSetOption(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>, MAT_IGNORE_OFF_PROC_ENTRIES, PETSC_TRUE);
<a name="l00968"></a>00968         MatSetOption(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, MAT_IGNORE_OFF_PROC_ENTRIES, PETSC_TRUE);
<a name="l00969"></a>00969 <span class="preprocessor">#else</span>
<a name="l00970"></a>00970 <span class="preprocessor"></span>        MatSetOption(<a class="code" href="classAbstractContinuumMechanicsSolver.html#aebea6311a32dac1a130d8cd29b983df1">mSystemLhsMatrix</a>, MAT_IGNORE_OFF_PROC_ENTRIES);
<a name="l00971"></a>00971         MatSetOption(<a class="code" href="classAbstractContinuumMechanicsSolver.html#a079a32c41ef28c033e88e490f6ba9d7b">mPreconditionMatrix</a>, MAT_IGNORE_OFF_PROC_ENTRIES);
<a name="l00972"></a>00972 <span class="preprocessor">#endif</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span>
<a name="l00974"></a>00974         <span class="comment">//unsigned total_non_zeros = 0;</span>
<a name="l00975"></a>00975         <span class="comment">//for (unsigned i=0; i&lt;mNumDofs; i++)</span>
<a name="l00976"></a>00976         <span class="comment">//{</span>
<a name="l00977"></a>00977         <span class="comment">//   total_non_zeros += num_non_zeros_each_row[i];</span>
<a name="l00978"></a>00978         <span class="comment">//}</span>
<a name="l00979"></a>00979         <span class="comment">//std::cout &lt;&lt; total_non_zeros &lt;&lt; &quot; versus &quot; &lt;&lt; 500*mNumDofs &lt;&lt; &quot;\n&quot; &lt;&lt; std::flush;</span>
<a name="l00980"></a>00980 
<a name="l00981"></a>00981         <span class="keyword">delete</span> [] num_non_zeros_each_row;
<a name="l00982"></a>00982     }
<a name="l00983"></a>00983 }
<a name="l00984"></a>00984 <span class="preprocessor">#endif // ABSTRACTCONTINUUMMECHANICSSOLVER_HPP_</span>
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.2 </small></address>
</body>
</html>
